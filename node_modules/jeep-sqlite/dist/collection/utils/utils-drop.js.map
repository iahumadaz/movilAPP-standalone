{"version":3,"file":"utils-drop.js","sourceRoot":"","sources":["../../src/utils/utils-drop.ts"],"names":[],"mappings":"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","sourcesContent":["import { UtilsSQLite } from './utils-sqlite';\n\nexport class UtilsDrop {\n\n  static async getTablesNames(db: any): Promise<string[]> {\n    let sql = 'SELECT name FROM sqlite_master WHERE ';\n    sql += \"type='table' AND name NOT LIKE 'sync_table' \";\n    sql += \"AND name NOT LIKE '_temp_%' \";\n    sql += \"AND name NOT LIKE 'sqlite_%' \";\n    sql += \"ORDER BY rootpage DESC;\";\n\n    const retArr: string[] = [];\n    try {\n      const retQuery: any[] = await UtilsSQLite.queryAll(db, sql, []);\n      for (const query of retQuery) {\n        retArr.push(query.name);\n      }\n      return Promise.resolve(retArr);\n    } catch (err) {\n      return Promise.reject(new Error(`GetTablesNames: ${err.message}`));\n    }\n  }\n  static async  getViewsNames(mDb: any): Promise<string[]> {\n      let sql = 'SELECT name FROM sqlite_master WHERE ';\n      sql += \"type='view' AND name NOT LIKE 'sqlite_%' \";\n      sql += 'ORDER BY rootpage DESC;';\n      const retArr: string[] = [];\n      try {\n        const retQuery: any[] = await UtilsSQLite.queryAll(mDb, sql, []);\n        for (const query of retQuery) {\n          retArr.push(query.name);\n        }\n        return Promise.resolve(retArr);\n      } catch (err) {\n        return Promise.reject(new Error(`getViewsNames: ${err.message}`));\n      }\n  }\n  static async  dropElements(db: any, type: string): Promise<void> {\n    let msg = '';\n    let stmt1 = `AND name NOT LIKE ('sqlite_%')`;\n    switch (type) {\n      case 'index':\n        msg = 'DropIndexes';\n        break;\n      case 'trigger':\n        msg = 'DropTriggers';\n        break;\n      case 'table':\n        msg = 'DropTables';\n        stmt1 += ` AND name NOT IN ('sync_table')`;\n        break;\n      case 'view':\n        msg = 'DropViews';\n        break;\n      default:\n        return Promise.reject(\n          new Error(`DropElements: ${type} ` + 'not found'),\n        );\n    }\n    // get the element's names\n    let stmt = 'SELECT name FROM sqlite_master WHERE ';\n    stmt += `type = '${type}' ${stmt1};`;\n    try {\n      const elements: any[] = await UtilsSQLite.queryAll(db, stmt, []);\n      if (elements.length > 0) {\n        const upType: string = type.toUpperCase();\n        const statements: string[] = [];\n        for (const elem of elements) {\n          let stmt = `DROP ${upType} IF EXISTS `;\n          stmt += `${elem.name};`;\n          statements.push(stmt);\n        }\n        for (const stmt of statements) {\n          const lastId: number = await UtilsSQLite.run(db, stmt, [], false, 'no');\n          if (lastId < 0) {\n            return Promise.reject(new Error(`DropElements: ${msg}: lastId < 0`));\n          }\n        }\n      }\n      return Promise.resolve();\n    } catch (err) {\n      return Promise.reject(new Error(`DropElements: ${msg}: ${err.message}`));\n    }\n  }\n  static async  dropAll(db: any): Promise<void> {\n    try {\n      // drop tables\n      await UtilsDrop.dropElements(db, 'table');\n      // drop indexes\n      await UtilsDrop.dropElements(db, 'index');\n      // drop triggers\n      await UtilsDrop.dropElements(db, 'trigger');\n      // drop views\n      await UtilsDrop.dropElements(db, 'view');\n      // vacuum the database\n      await UtilsSQLite.run(db, 'VACUUM;', [], false, 'no');\n      return Promise.resolve();\n    } catch (err) {\n      return Promise.reject(new Error(`DropAll: ${err.message}`));\n    }\n  }\n  static async  dropTempTables(db: any, alterTables: Record<string, string[]>): Promise<void>{\n    const tempTables: string[] = Object.keys(alterTables);\n    const statements: string[] = [];\n    for (const tTable of tempTables) {\n      let stmt = 'DROP TABLE IF EXISTS ';\n      stmt += `_temp_${tTable};`;\n      statements.push(stmt);\n    }\n    try {\n      const changes: number = await UtilsSQLite.execute(db, statements.join('\\n'), false);\n      if (changes < 0) {\n        return Promise.reject(new Error('DropTempTables: changes < 0'));\n      }\n      return Promise.resolve();\n    } catch (err) {\n      return Promise.reject(new Error(`DropTempTables: ${err.message}`));\n    }\n  }\n}\n"]}